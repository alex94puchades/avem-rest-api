{"version":3,"sources":["bin/init-db.js"],"names":[],"mappings":"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","file":"bin/init-db.js","sourcesContent":["import async from 'async';\nimport ask from 'ask-sync';\nimport mongoose from 'mongoose';\n\nimport config from '../../config';\nimport User from '../app/models/User';\nimport Role from '../app/models/Role';\nimport Client from '../app/models/Client';\n\nmongoose.connect(config.db.mongo.url);\n\ninitializeDatabase(err => {\n\terr ? console.log('Fatal error: %s', err.message) : console.log('Done');\n\tmongoose.disconnect();\n});\n\nfunction initializeDatabase(cb) {\n\tasync.waterfall([\n\t\tpopulateClientCollection,\n\t\tpopulateRoleCollection,\n\t\tpopulateUserCollection,\n\t], cb);\n}\n\nfunction populateClientCollection(done) {\n\tconsole.log('> Initialize AVEM Client Collection:');\n\tcreateTrustedClient((err, client) => {\n\t\tif (err) return done(err);\n\t\tconsole.log();\n\t\tdone(null, { trusted: client });\n\t});\n}\n\nfunction populateRoleCollection(clients, done) {\n\tconsole.log('> Initialize AVEM Role Collection:');\n\tasync.series({\n\t\tuser: cb => createUserRole(clients.trusted, cb),\n\t\tadmin: cb => createAdminRole(clients.trusted, cb),\n\t}, (err, results) => {\n\t\tif (err) return done(err);\n\t\tconsole.log();\n\t\tdone(null, results);\n\t});\n}\n\nfunction populateUserCollection(roles, done) {\n\tconsole.log('> Initialize AVEM User Collection:');\n\tcreateAdminUser(roles.admin, (err, user) => {\n\t\tif (err) return done(err);\n\t\tconsole.log();\n\t\tdone(null, { admin: user });\n\t});\n}\n\nfunction createTrustedClient(done) {\n\tlet data = ask({\n\t\tname: ask.string('Client name'),\n\t\tredirectUri: ask.string('Client redirect URI', { nullable: true }),\n\t});\n\tlet client = new Client;\n\tclient.name = data.name;\n\tclient.redirectUri = data.redirectUri;\n\tclient.trusted = true;\n\tclient.save((err, client) => {\n\t\tif (err) return done(err);\n\t\tconsole.log('Created trusted client:');\n\t\tconsole.log('- Client id: %s', client._id);\n\t\tconsole.log('- Client name: %s', client.name);\n\t\tconsole.log('- Client secret: %s', client.secret);\n\t\tconsole.log('- Client redirect URI: %s', client.redirectUri);\n\t\tdone(null, client);\n\t});\n}\n\nfunction createAdminRole(client, done) {\n\tlet role = new Role;\n\trole.name = 'admin';\n\trole.description = 'Privileged role for administrative tasks';\n\trole.privileges = [\n\t\t'user:enum', 'user:add', 'user:read', 'user:edit', 'user:edit-role',\n\t\t'user:remove',\n\t\t'role:enum', 'role:add', 'role:read', 'role:edit', 'role:remove',\n\t\t'client:enum', 'client:add', 'client:read', 'client:edit',\n\t\t'client:trust', 'client:remove',\n\t\t'access-token:enum', 'access-token:read', 'access-token:remove',\n\t\t'refresh-token:enum', 'refresh-token:read', 'refresh-token:remove',\n\t\t'session:enum', 'session:read', 'session:edit', 'session:remove',\n\t];\n\trole.save(err => {\n\t\tif (err) return done(err);\n\t\tconsole.log('Created admin role');\n\t\tdone(null, role);\n\t});\n}\n\nfunction createUserRole(client, done) {\n\tlet role = new Role;\n\trole.name = 'user';\n\trole.privileges = [];\n\trole.description = 'Standard role for regular users';\n\trole.save(err => {\n\t\tif (err) return done(err);\n\t\tconsole.log('Created user role');\n\t\tdone(null, role);\n\t});\n}\n\nfunction createAdminUser(role, done) {\n\tconsole.log('Creating AVEM Admin User:');\n\tlet data = ask({\n\t\temail: ask.string('User email'),\n\t\tpassword: ask.string('User password', {\n\t\t\tminLength: config.security.password.minLength,\n\t\t\tmaxLength: config.security.password.maxLength,\n\t\t}),\n\t});\n\tlet user = new User;\n\tuser.role = role._id;\n\tuser.email = data.email;\n\tuser.password = data.password;\n\tuser.save(err => {\n\t\tif (err) return done(err, false);\n\t\tconsole.log('Created admin user:');\n\t\tconsole.log('- User email: %s', user.email);\n\t\tconsole.log('- User password: %s', data.password); \n\t\tdone(null, user);\n\t});\n}\n"],"sourceRoot":"/source/"}