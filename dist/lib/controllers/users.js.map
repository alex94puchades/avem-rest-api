{"version":3,"sources":["lib/controllers/users.js"],"names":[],"mappings":"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","file":"lib/controllers/users.js","sourcesContent":["import {Router} from 'express';\nimport jsonapify, {Resource, Property, Template, Ref} from 'jsonapify';\n\nimport * as common from './common';\nimport * as logger from '../logger';\nimport {User} from '../models';\nimport {resource as roleResource} from './roles';\n\nvar userResource = new Resource(User, {\n\t'type': 'users',\n\t'id': {\n\t\tvalue: new Property('_id'),\n\t\twritable: false,\n\t},\n\t'links': {\n\t\t'self': {\n\t\t\tvalue: new Template('/users/${_id}'),\n\t\t\twritable: false,\n\t\t},\n\t},\n\t'attributes': {\n\t\t'email': new Property('email'),\n\t\t'password': {\n\t\t\tvalue: new Property('password'),\n\t\t\treadable: false,\n\t\t},\n\t},\n\t'relationships': {\n\t\t'role': new Ref(roleResource, 'role'),\n\t},\n});\n\nvar router = Router();\n\nrouter.get('/',\n\tcommon.authenticate('token-bearer'),\n\tcommon.requirePrivilege('user:enum'),\n\tjsonapify.enumerate(userResource),\n\tlogger.logErrors(), jsonapify.errorHandler());\n\nrouter.post('/',\n\tcommon.authenticate('token-bearer'),\n\tcommon.requirePrivilege('user:add'),\n\tjsonapify.create(userResource),\n\tlogger.logErrors(), jsonapify.errorHandler());\n\nfunction userIsSelf(req) {\n\tvar id = req.params.id;\n\tvar user = req.auth.user.info;\n\treturn user._id === id;\n}\n\nfunction ifNotSelf(priv) {\n\treturn (req) => {\n\t\treturn !userIsSelf(req) ? priv : false;\n\t};\n}\n\nfunction userEditRolePrivilege(req) {\n\tvar user = req.auth.user.info;\n\tvar path = 'body.data.relationships.role.id';\n\tvar newUserRole = _.get(req, path);\n\tif (!user || !newUserRole) return false;\n\tvar sameRole = user.role.equals(newUserRole);\n\treturn sameRole ? false : 'user:edit-role';\n}\n\nfunction userEditPrivilege(req) {\n\tif (!userIsSelf(req)) return 'user:edit';\n\treturn userEditRolePrivilege(req);\n}\n\nrouter.get('/:id',\n\tcommon.authenticate('token-bearer'),\n\tcommon.requirePrivilege(userEditPrivilege),\n\tjsonapify.read([userResource, jsonapify.param('id')]),\n\tlogger.logErrors(), jsonapify.errorHandler());\n\nrouter.put('/:id',\n\tcommon.authenticate('token-bearer'),\n\tcommon.requirePrivilege(userEditPrivilege),\n\tjsonapify.update([userResource, jsonapify.param('id')]),\n\tlogger.logErrors(), jsonapify.errorHandler());\n\nrouter.delete('/:id',\n\tcommon.authenticate('token-bearer'),\n\tcommon.requirePrivilege(ifNotSelf('user:remove')),\n\tjsonapify.remove([userResource, jsonapify.param('id')]),\n\tlogger.logErrors(), jsonapify.errorHandler());\n\nexport default router;\nexport { userResource as resource };\n"],"sourceRoot":"/source/"}