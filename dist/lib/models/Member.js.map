{"version":3,"sources":["lib/models/Member.js"],"names":[],"mappings":"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","file":"lib/models/Member.js","sourcesContent":["import util from 'util';\n\nimport _ from 'lodash';\nimport async from 'async';\nimport mongoose, {Schema} from 'mongoose';\n\nimport Transaction from './Transaction';\n\nconst memberSchema = new Schema({\n\tuser: {\n\t\ttype: Schema.ObjectId,\n\t\tref: 'User',\n\t\tindex: true,\n\t\trequired: true,\n\t},\n\tname: {\n\t\tfirst: {\n\t\t\ttype: String,\n\t\t\trequired: true,\n\t\t},\n\t\tlast: {\n\t\t\ttype: String,\n\t\t\trequired: true,\n\t\t},\n\t},\n\tgender: {\n\t\ttype: String,\n\t},\n\tbirthday: {\n\t\ttype: Number,\n\t},\n\tactiveUntil: {\n\t\ttype: Date,\n\t\trequired: true,\n\t},\n\tsubscribedActivities: [{\n\t\ttype: Schema.ObjectId,\n\t\tref: 'Activity',\n\t}],\n\tperformedActivities: [{\n\t\ttype: Schema.ObjectId,\n\t\tref: 'Activity',\n\t}],\n});\n\nmemberSchema.virtual('name.full').get(function() {\n\treturn util.format('%s %s', this.name.first, this.name.last);\n});\n\nmemberSchema.virtual('age').get(function() {\n\tif (!this.birthday) return null;\n\treturn new Date - this.birthday;\n});\n\nmemberSchema.virtual('active').get(function() {\n\treturn this.activeUntil < new Date;\n});\n\nmemberSchema.methods.getPoints = function(callback) {\n\tvar query = Transaction.find({ member: this._id });\n\tquery.sort({ _id: 1 }).select('points').exec((err, transactions) => {\n\t\tif (err) return callback(err);\n\t\tvar transactionPoints = _(transactions).pluck('points');\n\t\tcallback(null, transactionPoints.reduce((total, points) => {\n\t\t\treturn Math.max(0, total + points);\n\t\t}));\n\t});\n};\n\nmemberSchema.pre('remove', function(next) {\n\tTransaction.find({ member: this._id }, (err, transactions) => {\n\t\tif (err) return next(err);\n\t\tasync.each(transactions, (transaction, next) => {\n\t\t\ttransaction.remove(next);\n\t\t}, next);\n\t});\n});\n\nexport default mongoose.model('Member', memberSchema);\n"],"sourceRoot":"/source/"}