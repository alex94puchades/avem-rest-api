{"version":3,"sources":["lib/models/RefreshToken.js"],"names":[],"mappings":";;;;;;;;oBAAiB,MAAM;;;;wBACQ,UAAU;;;;uBAErB,WAAW;;;;sBACZ,iBAAiB;;;;AAEpC,SAAS,WAAW,GAAG;AACtB,QAAO,uBAAK,oBAAO,MAAM,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;CACxC;;AAED,IAAM,kBAAkB,GAAG,cATT,MAAM,CASc;AACrC,MAAK,EAAE;AACN,MAAI,EAAE,MAAM;AACZ,OAAK,EAAE,IAAI;AACX,QAAM,EAAE,IAAI;AACZ,UAAQ,EAAE,IAAI;AACd,aAAS,WAAW;EACpB;AACD,QAAO,EAAE;AACR,MAAI,EAAE,UAlBU,MAAM,CAkBT,QAAQ;AACrB,KAAG,EAAE,SAAS;AACd,OAAK,EAAE,IAAI;AACX,UAAQ,EAAE,IAAI;EACd;CACD,CAAC,CAAC;;AAEH,kBAAkB,CAAC,GAAG,CAAC,MAAM,EAAE,UAAS,IAAI,EAAE;AAC7C,sBAAQ,QAAQ,CAAC,IAAI,CAAC,OAAO,EAAE,UAAC,GAAG,EAAE,OAAO,EAAK;AAChD,MAAI,GAAG,IAAI,CAAC,OAAO,EAAE,OAAO,IAAI,CAAC,GAAG,CAAC,CAAC;AACtC,IAAE,OAAO,CAAC,UAAU,CAAC;AACrB,SAAO,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;EACnB,CAAC,CAAC;CACH,CAAC,CAAC;;AAEH,kBAAkB,CAAC,GAAG,CAAC,QAAQ,EAAE,UAAS,IAAI,EAAE;AAC/C,sBAAQ,QAAQ,CAAC,IAAI,CAAC,OAAO,EAAE,UAAC,GAAG,EAAE,OAAO,EAAK;AAChD,MAAI,GAAG,IAAI,CAAC,OAAO,EAAE,OAAO,IAAI,CAAC,GAAG,CAAC,CAAC;AACtC,MAAI,EAAE,OAAO,CAAC,UAAU,IAAI,CAAC,EAC5B,OAAO,OAAO,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;AAC7B,SAAO,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;EACnB,CAAC,CAAC;CACH,CAAC,CAAC;;qBAEY,sBAAS,KAAK,CAAC,cAAc,EAAE,kBAAkB,CAAC","file":"lib/models/RefreshToken.js","sourcesContent":["import uid2 from 'uid2';\nimport mongoose, {Schema} from 'mongoose';\n\nimport Session from './Session';\nimport config from '../../../config';\n\nfunction randomToken() {\n\treturn uid2(config.oauth2.token.length);\n}\n\nconst refreshTokenSchema = new Schema({\n\tvalue: {\n\t\ttype: String,\n\t\tindex: true,\n\t\tunique: true,\n\t\trequired: true,\n\t\tdefault: randomToken,\n\t},\n\tsession: {\n\t\ttype: Schema.ObjectId,\n\t\tref: 'Session',\n\t\tindex: true,\n\t\trequired: true,\n\t},\n});\n\nrefreshTokenSchema.pre('save', function(next) {\n\tSession.findById(this.session, (err, session) => {\n\t\tif (err || !session) return next(err);\n\t\t++session.references;\n\t\tsession.save(next);\n\t});\n});\n\nrefreshTokenSchema.pre('remove', function(next) {\n\tSession.findById(this.session, (err, session) => {\n\t\tif (err || !session) return next(err);\n\t\tif (--session.references <= 0)\n\t\t\treturn session.remove(next);\n\t\tsession.save(next);\n\t});\n});\n\nexport default mongoose.model('RefreshToken', refreshTokenSchema);\n"],"sourceRoot":"/source/"}