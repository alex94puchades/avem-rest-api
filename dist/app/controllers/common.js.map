{"version":3,"sources":["app/controllers/common.js"],"names":[],"mappings":";;;;;QAOgB,YAAY,GAAZ,YAAY;QAOZ,gBAAgB,GAAhB,gBAAgB;QAUhB,cAAc,GAAd,cAAc;QAad,kBAAkB,GAAlB,kBAAkB;;;;;;qBArChB,OAAO;;;;yBACH,WAAW;;;;yBAEX,cAAc;;IAAxB,IAAI;;wBACK,aAAa;;;;sBACC,WAAW;;AAEvC,SAAS,YAAY,CAAC,OAAO,EAAE;AACrC,QAAO,CACN,sBAAS,YAAY,CAAC,OAAO,EAAE,EAAE,OAAO,EAAE,KAAK,EAAE,CAAC,EAClD,IAAI,CAAC,QAAQ,EAAE,CACf,CAAC;CACF;;AAEM,SAAS,gBAAgB,CAAC,IAAI,EAAE;AACtC,QAAO,IAAI,CAAC,gBAAgB,CAAC,IAAI,EAAE;AAClC,gBAAc,EAAE,gBAAgB;EAChC,CAAC,CAAC;;AAEH,UAAS,gBAAgB,CAAC,GAAG,EAAE,GAAG,EAAE,IAAI,EAAE;AACzC,MAAI,CAAC,IAAI,uBAAU,MAAM,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC,CAAC;EAC1C;CACD;;AAEM,SAAS,cAAc,CAAC,GAAG,EAAE,QAAQ,EAAE;AAC7C,KAAI,KAAK,GAAG,kBAAkB,CAAC,GAAG,CAAC,CAAC;AACpC,oBAAM,SAAS,CAAC,CACf,UAAC,IAAI,EAAK;AACT,UAvBc,WAAW,CAuBb,OAAO,CAAC,EAAE,KAAK,EAAE,KAAK,EAAE,EAAE,IAAI,CAAC,CAAC;EAC5C,EACD,UAAC,WAAW,EAAE,IAAI,EAAK;AACtB,MAAI,CAAC,WAAW,EAAE,OAAO,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,CAAC;AAC7C,UA3BK,OAAO,CA2BJ,QAAQ,CAAC,WAAW,CAAC,OAAO,EAAE,IAAI,CAAC,CAAC;EAC5C,CACD,EAAE,QAAQ,CAAC,CAAC;CACb;;AAEM,SAAS,kBAAkB,CAAC,GAAG,EAAE;AACvC,KAAI,KAAK,GAAG,kBAAkB,CAAC,GAAG,CAAC,CAAC;AACpC,KAAI,CAAC,KAAK,EAAE,KAAK,GAAG,eAAe,CAAC,GAAG,CAAC,CAAC;AACzC,KAAI,CAAC,KAAK,EAAE,KAAK,GAAG,gBAAgB,CAAC,GAAG,CAAC,CAAC;AAC1C,QAAO,KAAK,CAAC;;AAEb,UAAS,kBAAkB,CAAC,GAAG,EAAE;AAChC,MAAI,UAAU,GAAG,GAAG,CAAC,OAAO,CAAC,aAAa,CAAC;AAC3C,MAAI,CAAC,UAAU,EACd,OAAO,SAAS,CAAC;AAClB,MAAI,QAAQ,GAAG,UAAU,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;AACrC,MAAI,QAAQ,CAAC,MAAM,KAAK,CAAC,IAAI,QAAQ,CAAC,CAAC,CAAC,KAAK,QAAQ,EACpD,OAAO,SAAS,CAAC;AAClB,SAAO,QAAQ,CAAC,CAAC,CAAC,CAAC;EACnB;;AAED,UAAS,eAAe,CAAC,GAAG,EAAE;AAC7B,SAAO,GAAG,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;EAChC;;AAED,UAAS,gBAAgB,CAAC,GAAG,EAAE;AAC9B,SAAO,GAAG,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;EAChC;CACD","file":"app/controllers/common.js","sourcesContent":["import async from 'async';\nimport jsonapify from 'jsonapify';\n\nimport * as auth from '../authority';\nimport passport from '../passport';\nimport {Session, AccessToken} from '../models';\n\nexport function authenticate(methods) {\n\treturn [\n\t\tpassport.authenticate(methods, { session: false }),\n\t\tauth.identify(),\n\t];\n}\n\nexport function requirePrivilege(priv) {\n\treturn auth.requirePrivilege(priv, {\n\t\tonAccessDenied: sendAccessDenied,\n\t});\n\t\n\tfunction sendAccessDenied(req, res, next) {\n\t\tnext(new jsonapify.errors.HttpError(403));\n\t}\n}\n\nexport function currentSession(req, callback) {\n\tvar token = extractAccessToken(req);\n\tasync.waterfall([\n\t\t(next) => {\n\t\t\tAccessToken.findOne({ value: token }, next);\n\t\t},\n\t\t(accessToken, next) => {\n\t\t\tif (!accessToken) return next('break', null);\n\t\t\tSession.findById(accessToken.session, next);\n\t\t},\n\t], callback);\n}\n\nexport function extractAccessToken(req) {\n\tvar token = extractFromHeaders(req);\n\tif (!token) token = extractFromBody(req);\n\tif (!token) token = extractFromQuery(req);\n\treturn token;\n\t\n\tfunction extractFromHeaders(req) {\n\t\tvar authHeader = req.headers.authorization;\n\t\tif (!authHeader)\n\t\t\treturn undefined;\n\t\tvar authData = authHeader.split(' ');\n\t\tif (authData.length !== 2 || authData[0] !== 'Bearer')\n\t\t\treturn undefined;\n\t\treturn authData[1];\n\t}\n\t\n\tfunction extractFromBody(req) {\n\t\treturn req.body['access_token'];\n\t}\n\t\n\tfunction extractFromQuery(req) {\n\t\treturn req.body['access_token'];\n\t}\n}\n"],"sourceRoot":"/source/"}