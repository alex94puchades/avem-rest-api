{"version":3,"sources":["app/passport.js"],"names":[],"mappings":";;;;;;;;qBAAkB,OAAO;;;;wBACJ,UAAU;;;;4BACH,eAAe;;iCACb,oBAAoB;;;;kCACT,sBAAsB;;0CAChB,+BAA+B;;4CAC7B,iCAAiC;;0BAEjE,eAAe;;;;4BACb,iBAAiB;;;;6BAChB,kBAAkB;;;;iCACd,sBAAsB;;;;AAE9C,sBAAS,GAAG,CAAC,oCAAqB,CAAC,CAAC;;AAEpC,SAAS,4BAA4B,CAAC,QAAQ,EAAE,YAAY,EAAE,IAAI,EAAE;AACnE,2BAAO,QAAQ,CAAC,QAAQ,EAAE,UAAC,GAAG,EAAE,MAAM,EAAK;AAC1C,MAAI,GAAG,IAAI,CAAC,MAAM,EAAE,OAAO,IAAI,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC;AAC5C,MAAI,MAAM,CAAC,MAAM,KAAK,YAAY,EAAE,OAAO,IAAI,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;AAC7D,MAAI,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC;EACnB,CAAC,CAAC;CACH;;AAED,sBAAS,GAAG,CAAC,cAAc,EAAE,kBArBrB,aAAa,CAqB0B,4BAA4B,CAAC,CAAC,CAAC;AAC9E,sBAAS,GAAG,CAAC,iBAAiB,EAAE,kCAlBxB,QAAQ,CAkB2C,4BAA4B,CAAC,CAAC,CAAC;;AAE1F,sBAAS,GAAG,CAAC,eAAe,EAAE,gCArBtB,QAAQ,CAqBuC,UAAC,QAAQ,EAAE,IAAI,EAAK;AAC1E,2BAAO,QAAQ,CAAC,QAAQ,EAAE,IAAI,CAAC,CAAC;CAChC,CAAC,CAAC,CAAC;;AAEJ,sBAAS,GAAG,CAAC,cAAc,EAAE,wBA1BrB,QAAQ,CA0BgC,UAAC,MAAM,EAAE,IAAI,EAAK;AACjE,oBAAM,SAAS,CAAC,CACf,UAAC,IAAI,EAAK;AACT,iCAAY,OAAO,CAAC,EAAE,KAAK,EAAE,MAAM,EAAE,EAAE,IAAI,CAAC,CAAC;EAC7C,EACD,UAAC,KAAK,EAAE,IAAI,EAAK;AAChB,MAAI,CAAC,KAAK,IAAI,KAAK,CAAC,OAAO,EAAE,OAAO,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,CAAC;AACxD,6BAAQ,QAAQ,CAAC,KAAK,CAAC,OAAO,EAAE,IAAI,CAAC,CAAC;EACtC,EACD,UAAC,OAAO,EAAE,IAAI,EAAK;AAClB,MAAI,CAAC,OAAO,EAAE,OAAO,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,CAAC;AACzC,0BAAK,QAAQ,CAAC,OAAO,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;EAClC,CACD,EAAE,UAAC,GAAG,EAAE,IAAI,EAAK;AACjB,MAAI,GAAG,IAAI,GAAG,KAAK,OAAO,EAAE,OAAO,IAAI,CAAC,GAAG,CAAC,CAAC;AAC7C,MAAI,CAAC,IAAI,EAAE,OAAO,IAAI,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;AACpC,MAAI,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;EACjB,CAAC,CAAC;CACH,CAAC,CAAC,CAAC","file":"app/passport.js","sourcesContent":["import async from 'async';\nimport passport from 'passport';\nimport {BasicStrategy} from 'passport-http';\nimport AnonymousStrategy from 'passport-anonymous';\nimport {Strategy as BearerStrategy} from 'passport-http-bearer';\nimport {Strategy as PublicClientStrategy} from 'passport-oauth2-public-client';\nimport {Strategy as ClientPasswordStrategy} from 'passport-oauth2-client-password';\n\nimport User from './models/User';\nimport Client from './models/Client';\nimport Session from './models/Session';\nimport AccessToken from './models/AccessToken';\n\npassport.use(new AnonymousStrategy);\n\nfunction authenticateClientWithSecret(clientId, clientSecret, done) {\n\tClient.findById(clientId, (err, client) => {\n\t\tif (err || !client) return done(err, false);\n\t\tif (client.secret !== clientSecret) return done(null, false);\n\t\tdone(null, client);\n\t});\n}\n\npassport.use('client-basic', new BasicStrategy(authenticateClientWithSecret));\npassport.use('client-password', new ClientPasswordStrategy(authenticateClientWithSecret));\n\npassport.use('client-public', new PublicClientStrategy((clientId, done) => {\n\tClient.findById(clientId, done);\n}));\n\npassport.use('token-bearer', new BearerStrategy((bearer, done) => {\n\tasync.waterfall([\n\t\t(next) => {\n\t\t\tAccessToken.findOne({ value: bearer }, next);\n\t\t},\n\t\t(token, next) => {\n\t\t\tif (!token || token.expired) return next('break', null);\n\t\t\tSession.findById(token.session, next);\n\t\t},\n\t\t(session, next) => {\n\t\t\tif (!session) return next('break', null);\n\t\t\tUser.findById(session.user, next);\n\t\t},\n\t], (err, user) => {\n\t\tif (err && err !== 'break') return done(err);\n\t\tif (!user) return done(null, false);\n\t\tdone(null, user);\n\t});\n}));\n\nexport default passport;\n"],"sourceRoot":"/source/"}