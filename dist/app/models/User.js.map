{"version":3,"sources":["app/models/User.js"],"names":[],"mappings":";;;;;;;;sBAAc,QAAQ;;;;sBACH,QAAQ;;;;wBACI,UAAU;;;;sBAEtB,iBAAiB;;;;AAEpC,IAAM,UAAU,GAAG,cAJD,MAAM,CAIM;AAC7B,MAAK,EAAE;AACN,MAAI,EAAE,MAAM;AACZ,OAAK,EAAE,IAAI;AACX,QAAM,EAAE,IAAI;AACZ,OAAK,EAAE,2CAA2C;AAClD,UAAQ,EAAE,IAAI;EACd;AACD,aAAY,EAAE;AACb,MAAI,EAAE,MAAM;EACZ;AACD,KAAI,EAAE;AACL,MAAI,EAAE,UAhBU,MAAM,CAgBT,QAAQ;AACrB,KAAG,EAAE,MAAM;AACX,UAAQ,EAAE,IAAI;EACd;CACD,CAAC,CAAC;;AAEH,UAAU,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC,GAAG,CAAC,UAAS,QAAQ,EAAE;AACrD,KAAI,QAAQ,GAAG,QAAQ,CAAC,MAAM,CAAC;AAC/B,KAAI,QAAQ,GAAG,oBAAO,QAAQ,CAAC,QAAQ,CAAC,SAAS,EAAE;AAClD,MAAI,CAAC,UAAU,CAAC,UAAU,EAAE,oBAAoB,EAAE,QAAQ,CAAC,CAAC;AAC5D,QAAM,IAAI,KAAK,CAAC,oBAAoB,CAAC,CAAC;EACtC,MAAM,IAAI,QAAQ,GAAG,oBAAO,QAAQ,CAAC,QAAQ,CAAC,SAAS,EAAE;AACzD,MAAI,CAAC,UAAU,CAAC,UAAU,EAAE,mBAAmB,EAAE,QAAQ,CAAC,CAAC;AAC3D,QAAM,IAAI,KAAK,CAAC,mBAAmB,CAAC,CAAC;EACrC;AACD,KAAI,CAAC,SAAS,GAAG,QAAQ,CAAC;CAC1B,CAAC,CAAC;;AAEH,UAAU,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC,QAAQ,CAAC,UAAS,KAAK,EAAE;AACxD,KAAI,oBAAE,WAAW,CAAC,IAAI,CAAC,SAAS,CAAC,IAC7B,oBAAE,WAAW,CAAC,IAAI,CAAC,YAAY,CAAC,EAAE;AACjC,MAAI,CAAC,UAAU,CAAC,UAAU,EAAE,yBAAyB,CAAC,CAAC;AACvD,QAAM,IAAI,KAAK,CAAC,yBAAyB,CAAC,CAAC;EAC/C;CACD,CAAC,CAAC;;AAEH,UAAU,CAAC,GAAG,CAAC,MAAM,EAAE,UAAS,IAAI,EAAE;AACrC,KAAI,oBAAE,WAAW,CAAC,IAAI,CAAC,SAAS,CAAC,EAChC,OAAO,IAAI,EAAE,CAAC;AACf,KAAI,IAAI,GAAG,IAAI,CAAC;AAChB,KAAI,KAAK,GAAG,IAAI,MAAM,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;AACvC,KAAI,MAAM,GAAG,oBAAO,YAAY,sBAAS,oBAAO,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;AACtE,qBAAO,IAAI,CAAC,KAAK,EAAE,MAAM,EAAE,UAAC,GAAG,EAAE,IAAI,EAAK;AACzC,MAAI,GAAG,EAAE,OAAO,IAAI,CAAC,GAAG,CAAC,CAAC;AAC1B,MAAI,CAAC,YAAY,GAAG,IAAI,CAAC;AACzB,MAAI,EAAE,CAAC;EACP,CAAC,CAAC;CACH,CAAC,CAAC;;AAEH,UAAU,CAAC,OAAO,CAAC,cAAc,GAAG,UAAS,QAAQ,EAAE,EAAE,EAAE;AAC1D,KAAI,KAAK,GAAG,IAAI,MAAM,CAAC,QAAQ,CAAC,CAAC;AACjC,qBAAO,MAAM,CAAC,IAAI,CAAC,YAAY,EAAE,KAAK,EAAE,UAAC,GAAG,EAAE,OAAO,EAAK;AACzD,SAAO,EAAE,CAAC,IAAI,EAAE,CAAC,GAAG,IAAI,OAAO,CAAC,CAAC;EACjC,CAAC,CAAC;CACH,CAAC;;qBAEa,sBAAS,KAAK,CAAC,MAAM,EAAE,UAAU,CAAC","file":"app/models/User.js","sourcesContent":["import _ from 'lodash';\nimport scrypt from 'scrypt';\nimport mongoose, {Schema} from 'mongoose';\n\nimport config from '../../../config';\n\nconst userSchema = new Schema({\n\temail: {\n\t\ttype: String,\n\t\tindex: true,\n\t\tunique: true,\n\t\tmatch: /^[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,4}$/i,\n\t\trequired: true,\n\t},\n\tpasswordHash: {\n\t\ttype: Buffer,\n\t},\n\trole: {\n\t\ttype: Schema.ObjectId,\n\t\tref: 'Role',\n\t\trequired: true,\n\t},\n});\n\nuserSchema.virtual('password').set(function(password) {\n\tvar pwLength = password.length;\n\tif (pwLength < config.security.password.minLength) {\n\t\tself.invalidate('password', 'password too short', pwLength);\n\t\tthrow new Error('password too short');\n\t} else if (pwLength > config.security.password.maxLength) {\n\t\tself.invalidate('password', 'password too long', pwLength);\n\t\tthrow new Error('password too long');\n\t}\n\tthis._password = password;\n});\n\nuserSchema.path('passwordHash').validate(function(value) {\n\tif (_.isUndefined(this._password) &&\n\t    _.isUndefined(this.passwordHash)) {\n\t    \tself.invalidate('password', 'password field required');\n\t    \tthrow new Error('password field required');\n\t}\n});\n\nuserSchema.pre('save', function(next) {\n\tif (_.isUndefined(this._password))\n\t\treturn next();\n\tvar self = this;\n\tvar pwBuf = new Buffer(this._password);\n\tvar params = config.scryptParams(scrypt, config.security.hash.scrypt);\n\tscrypt.hash(pwBuf, params, (err, hash) => {\n\t\tif (err) return next(err);\n\t\tself.passwordHash = hash;\n\t\tnext();\n\t});\n});\n\nuserSchema.methods.verifyPassword = function(password, cb) {\n\tvar pwBuf = new Buffer(password);\n\tscrypt.verify(this.passwordHash, pwBuf, (err, isMatch) => {\n\t\treturn cb(null, !err && isMatch);\n\t});\n};\n\nexport default mongoose.model('User', userSchema);\n"],"sourceRoot":"/source/"}